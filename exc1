use Inda
go
--4.1 Вывести список сотрудников, которые получают заработную плату ниже, чем у непосредственного руководителя.
select e.NAME
from Employee as e
left join Employee as b on b.ID = e.CHIEF_ID
where e.SALARY<b.SALARY
--4.2 Вывести список сотрудников, которые получают в отделе минимальную заработную плату в своем отделе.
select distinct d.NAME, 
MIN(e.SALARY) as 'MinSalary'
from Employee as e
left join Department as d on e.DEPARTMENT_ID = d.ID
group by d.name
--4.3 Вывести список ID отделов, количество сотрудников в которых не превышает трех человек.
select count(*) as EmployesCount
from Department as d
left join Employee as e on e.DEPARTMENT_ID = d.ID
group by d.NAME
having COUNT(*)<=3
--4.4 Вывести список сотрудников, не имеющих назначенного руководителя, который работал бы в том же отделе.
select e.NAME
from Employee as e
left join Employee as b on b.ID = e.CHIEF_ID
where b.DEPARTMENT_ID!=e.DEPARTMENT_ID
--4.5 Найти список ID отделов с максимальной суммарной заработной платой сотрудников.
select s.ID, s.SumSalary  from
(
	select d.ID, SUM(e.SALARY) as SumSalary
	from Department as d
	left join Employee as e on e.DEPARTMENT_ID = d.ID
	group by d.ID
) as s
where s.SumSalary = (
					--TODO: подумать над улучшением
					select top 1 SUM(e.SALARY) as SumSalary
					from Department as d
					left join Employee as e on e.DEPARTMENT_ID = d.ID
					group by d.ID
					order by SUM(e.SALARY) DESC
)
